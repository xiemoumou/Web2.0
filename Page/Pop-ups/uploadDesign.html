<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>客服上传设计稿</title>
    <script id="ver" src="../../Common/Js/version.js" type="text/javascript"></script>
    <script>
        var random = Math.random();
        var versionDoc = document.getElementById("ver");
        versionDoc.attributes.src.value = versionDoc.attributes.src.value + "?v=" + random;
        document.write('<link href="../../Common/Css/base.css' + VER + '" rel="stylesheet" />');
        document.write('<link href="../../Common/Components/library.css' + VER + '" rel="stylesheet" />');
        document.write('<script type="text/javascript" src="../../Common/Lib/jquery/jquery-1.11.0.min.js' + VER + '" ><\/script>');
    </script>
    <style>
        body {
            background-color: #fff;
        }

        .container {
            padding: 10px 40px;
        }

        .center {
            margin: 0 auto;
        }

        .info {
            background-color: #FFF1F0;
            height: 45px;
            border: 1px solid #EC7171;
            padding: 10px 10px 10px 15px;
            box-shadow: 0 0 2px 0 #EC7171;
            border-radius: 3px;
            position: relative;
            margin-bottom: 18px;
        }

        .icon-warning {
            font-size: 14px;
            color: #E84B4C;
        }

        .info p {
            color: #E84B4C;
            font-size: 14px;
            line-height: 14px;
            display: inline-block;
        }

        .upload {
            position: relative;
        }

        /*remarks*/
        .requirements-content {
            height: 84px;
            border: 1px solid #d7d7d7;
            border-radius: 4px;
            padding: 3px;
        }

        .design-annex,.other-annex{
            position: relative;
        }

        #accessory{
            width: 240px;
            border: 1px dashed #D5D5D5;
            padding-bottom: 10px;
            margin-right: 10px;
        }

        /*设计师备注附件*/
        #reference .addDiagram .dia-icon{
            width: 18px;
            height: 16px;
            position: absolute;
            top: -58px;
            left: -22px;
            background: url(../../Image/Designer/desiDesigner.png) no-repeat -56px -5px !important;
        }
        #reference .addDiagram .dia-icon:before{
            content: '点击上传';
            position: absolute;
            display: inline-block;
            width: 48px;
            color: #E84B4C;
            font-size: 12px;
            line-height: 11px;
            left: 26px;
            border-bottom: 1px solid;
        }
        #reference .addDiagram .dia-icon:after{
            content: '备注图片(最多3张)';
            position: absolute;
            display: inline-block;
            width: 100px;
            color: #D5D5D5;
            font-size: 12px;
            line-height: 11px;
            left: 80px;
            cursor: auto;
        }

        #reference .diagram{
            width: 48px;
            height: 48px;
        }

        #reference .diagram img{
            max-width: 48px;
            max-height: 48px;
        }

        #reference .diagram .progress span{
            font-size: 12px;
        }

        #reference .diagram .handle .oper
        {
            margin: 0 !important;
        }

        #reference .dia-remind-1,#reference .dia-remind-2{
            display: none;
        }

        #reference .diagram{
            z-index: 2;
        }
        #reference .addDiagram{
            position: absolute;
            background-color: transparent;
            box-shadow: none;
            z-index: 1;
        }
        #reference .addDiagram:hover {
            box-shadow: none;
        }

        .requirements-content textarea{
            height: 46px !important;
        }

        .requirements-content .textarea .remark
        {
            line-height: 60px;
        }


        #accessory .accessory-container .filelist .fileitem{
            margin-left: 5px;
        }

        #otherAccessory{
            width: 240px;
            border: 1px dashed #D5D5D5;
            padding-bottom: 10px;
            margin-top: 18px;
        }

        #otherAccessory .accessory-container .filelist .fileitem{
            margin-left: 5px;
        }

        .production-requirements {
            height: 100px;
            width: 100%;
            margin-top: 15px;
            position: relative;
        }

        .ok {
            width: 114px;
            height: 38px;
            display: inline-block;
            margin-right: 20px;
        }

        .hollow-button {
            width: 114px;
            height: 38px;
            display: inline-block;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="info center">
        <span class="icon-warning">提示信息：</span>
        <p>此订单尚未完成设计，继续分配生产将忽略本订单的设计师方案，如果您确认有可以生产的设计方案文件，请将方案提交到下方区域。</p>
    </div>
    <div class="main">
        <div class="upload">
            <!-- 上传图片 -->
            <div class="upload-photo clearfix">
                <div class="design-photo fl" style="width: 252px;">
                    <span class="label">设计图：</span>
                    <div id="reference_diagram" class="clearfix" style="height: 109px;" data-type="design_image"> </div>
                </div>
                <div class="design-annex fl">
                    <span class="label">附件：</span>
                    <span class="label" style="position: absolute; right: 15px; top: 20px; color: #999999; padding: 0 2px; background-color: #F5F5F5;" >设计附件</span>
                    <div id="accessory" class="clearfix" data-type="design_accessory"> </div>
                </div>
                <div class="other-annex fl">
                    <span class="label" style="position: absolute; right: 4px; top: 20px; color: #999999; padding: 0 2px; background-color: #F5F5F5;">其它附件</span>
                    <div id="otherAccessory" class="clearfix" data-type="other_accessory"> </div>
                </div>
            </div>
            <div class="production-requirements">
                <label class="upload-photo-label">设计备注：</label>
                <div class="requirements-content">
                </div>
            </div>
            <div class="remarks clearfix">
                <div id="reference" class="clearfix" data-type="design_image" style="margin-top: 30px;">

                </div>
            </div>
        </div>
    </div>
    <div class="footer center">
        <button class="ok red-button btn">提交</button>
        <button class="hollow-button btn-h"
                onclick="parent.layer.closeAll();">取消
        </button>
    </div>
</div>
<script>
    document.write('<script type="text/javascript" src="../../Common/Lib/jquery/jquery.cookie.js' + VER + '" ><\/script>');
    document.write('<script type="text/javascript" src="../../Common/Lib/layer-v3.1.1/layer/layer.js' + VER + '" ><\/script>');
    document.write('<script type="text/javascript" src="../../Common/Js/global.js' + VER + '" ><\/script>');
    document.write('<script type="text/javascript" src="../../Common/Components/library.js' + VER + '" ><\/script>');
</script>
<script>
    var customid = "";//客户id
    var title="";
    $(function () {
        //初始化上传操作
        customid = Helper.getUrlParam("customid");
        var designPatternId=Helper.getUrlParam("designPatternId");//设计方案ID
        title=Helper.getUrlParam('title',true);

        var designImage=[];//设计图
        var designFile=[];//设计附件
        var otherFile=[];//其他附件

        var designMemo="";//设计备注
        var remarkImage=[];//设计备注图片

        debugger


        //修正设计稿回显示
        if(designPatternId && designPatternId!="undefined")
        {
            var url=config.WebService()["orderDesignPatternById_Query"];
            top.Requst.ajaxGet(url,{"id":parseInt(designPatternId)},false,function (data) {
                if(data.code==200)
                {
                    data=data.data[0];
                    designImage.push({'thumbnail':"http://"+data.smallDesignImage1,'orgSrc':"http://"+data.middleDesignImage1});//设计图
                    designFile.push({"name":data.designFile,"uri":"http://"+data.designFile});//设计附件
                    otherFile.push({"name":data.otherFile,"uri":"http://"+data.otherFile});//其他附件

                    for(var i=1;i<3;i++) {
                        if (data["smallRemarkImage" + i])
                        {
                            remarkImage.push({"thumbnail":"http://"+data["smallRemarkImage"+i],"orgSrc":"http://"+data["middleRemarkImage"+i]});
                        }
                    }

                    designMemo=data.designMemo;//设计备注

                }
                else
                {
                    console.log(data.message);
                }
            });
        }

        uploadfile.uploadPhoto('reference_diagram', 1,designImage);//图片上传
        uploadfile.uploadFile('accessory', 1, designFile, true, null,null,true);//附件上传
        uploadfile.uploadFile('otherAccessory', 1, otherFile, true, null,false,true);//附件上传
        textArea.init('.requirements-content', 300, designMemo, '请输入设计备注，请留意：备注不允许出现产品价格，参数和旺旺等各种联系方式', '备注不允许出现产品价格、参数和旺旺等各种联系方式');

        uploadfile.uploadPhoto('reference',3,remarkImage);//设计备注图片上传

        uploadfile.initDrag('reference_diagram');//拖拽支持
        uploadfile.initDrag('accessory');//拖拽支持
        uploadfile.initDrag('otherAccessory');



        $(".ok").on('click',function () {
            var requstData = {"version": 1, "isNew": 1, "customid": customid, "status": 5};//提交参数

            //设计图
            var diagram = $("#reference_diagram .diagram-container .diagram");
            if (diagram.length > 0) {

                var complete = $(diagram[0]).attr("data-complete");
                if (complete && complete != "complete") {
                    top.Message.show("提示", "设计图正在上传...", MsgState.Warning, 2000);
                    return;
                }
                else {
                    requstData["initialDesignImage1"] = $(diagram[0]).attr("data-mimageurl");
                    requstData["middleDesignImage1"] = $(diagram[0]).attr("data-mimageurl");
                    requstData["smallDesignImage1"] = $(diagram[0]).attr("data-simageurl");
                }
            }
            else
            {
                top.Message.show("提示", "请上传设计图", MsgState.Warning, 2000);
                return;
            }

            //附件
            var accessory=$("#accessory .accessory-container .fileitem");
            if(accessory.length>0)
            {
                var complete=$(accessory[0]).attr("data-complete");
                if(complete && complete!="complete")
                {
                    top.Message.show("提示","附件正在上传...",MsgState.Warning,2000);
                    return;
                }
                else
                {
                    requstData["designFile"]=$(accessory[0]).attr("data-url");
                }
            }
            else
            {
                top.Message.show("提示", "请上传设附件", MsgState.Warning, 2000);
                return;
            }

            //其他附件
            var otherAccessory=$("#otherAccessory .accessory-container .fileitem");
            if(otherAccessory.length>0)
            {
                var complete=$(otherAccessory[0]).attr("data-complete");
                if(complete && complete!="complete")
                {
                    top.Message.show("提示","其他附件正在上传...",MsgState.Warning,2000);
                    return;
                }
                else
                {
                    requstData["otherFile"]=$(otherAccessory[0]).attr("data-url");
                }
            }


            //备注参考图
            var reference=$("#reference .diagram-container .diagram");
            if(reference.length>0)
            {
                for(var i=0;i<reference.length;i++)
                {
                    var complete=$(reference[i]).attr("data-complete");
                    if(complete && complete!="complete")
                    {
                        top.Message.show("提示","备注图片正在上传...",MsgState.Warning,2000);
                        return;
                    }
                    else
                    {
                        requstData["initialRemarkImage"+(i+1)]=$(diagram[0]).attr("data-mimageurl");
                        requstData["middleRemarkImage"+(i+1)]=$(diagram[0]).attr("data-mimageurl");
                        requstData["smallRemarkImage"+(i+1)]=$(diagram[0]).attr("data-simageurl");
                    }
                }
            }

            requstData["designMemo"]=$('.production-requirements textarea').val();//设计备注
            var url=config.WebService()["orderDesignPattern_Insert"];

            top.Requst.ajaxPost(url,requstData,true,function (data) {
                if(data.code==200)
                {
                    top.Message.show("提示",data.message,MsgState.Success,2000,function () {
                        if (top.document.getElementById("iframe_"+customid)) {
                            var pageObject=top.document.getElementById("iframe_"+customid).contentWindow;

                            //调用李远鹏的更新设计稿方法
                        }
                        if(top.document.getElementById("iframe_"+customid))
                        {
                            top.document.getElementById("iframe_"+customid).contentWindow.details.getData("designDraft");
                        }
                        top.Popup.close(title);
                    });
                }
                else
                {
                    top.Message.show("提示",data.message,MsgState.Warning,2000);
                }
            });
        });
    });
</script>
</body>
</html>