/**
 * Created by inshijie on 2018/8/2.
 */

var datasource = [
    {
        "id": "0",
        "type": "类型1",
        "name": "方形绒布红-皮筋",
        "color": "红色",
        "texture": "绒布",
        "length": "52",
        "weight": "55",
        "height": "24",
        "price": "5.00",
        "filename": "shandardred.png",
        "tumbnail1": "shandardred@30.png",
        "tumbnail2": "shandardred@2x.png",
        "tumbnail3": "shandardred@3x.png"
    },
    {
        "id": "1",
        "type": "类型2",
        "name": "方形绒布蓝-皮筋",
        "color": "蓝色",
        "texture": "绒布",
        "length": "52",
        "weight": "55",
        "height": "24",
        "price": "5.00",
        "filename": "shandardblue.png",
        "tumbnail1": "shandardblue@30.png",
        "tumbnail2": "shandardblue@2x.png",
        "tumbnail3": "shandardblue@3x.png"
    },
    {
        "id": "2",
        "type": "类型3",
        "name": "方形绒布黑-皮筋",
        "color": "黑色",
        "texture": "绒布",
        "length": "52",
        "weight": "55",
        "height": "24",
        "price": "5.00",
        "filename": "shandardblack.png",
        "tumbnail1": "shandardblack@30.png",
        "tumbnail2": "shandardblack@2x.png",
        "tumbnail3": "shandardblack@3x.png"
    },
    {
        "id": "3",
        "type": "类型4",
        "name": "方形绒布红-卡纸",
        "color": "红色",
        "texture": "绒布",
        "length": "52",
        "weight": "55",
        "height": "24",
        "price": "5.00",
        "filename": "holered.png",
        "tumbnail1": "holered@30.png",
        "tumbnail2": "holered@2x.png",
        "tumbnail3": "holered@3x.png"
    },
    {
        "id": "4",
        "type": "类型5",
        "name": "方形绒布蓝-卡纸",
        "color": "蓝色",
        "texture": "绒布",
        "length": "52",
        "weight": "55",
        "height": "24",
        "price": "5.00",
        "filename": "holeblue.png",
        "tumbnail1": "holeblue@30.png",
        "tumbnail2": "holeblue@2x.png",
        "tumbnail3": "holeblue@3x.png"
    },
    {
        "id": "5",
        "type": "类型6",
        "name": "方形绒布黑-卡纸",
        "color": "黑色",
        "texture": "绒布",
        "length": "52",
        "weight": "55",
        "height": "24",
        "price": "5.00",
        "filename": "holeblack.png",
        "tumbnail1": "holeblack@30.png",
        "tumbnail2": "holeblack@2x.png",
        "tumbnail3": "holeblack@3x.png"
    },
    {
        "id": "6",
        "type": "类型7",
        "name": "圆顶绒布红-矮款",
        "color": "红色",
        "texture": "绒布",
        "length": "48",
        "weight": "48",
        "height": "26",
        "price": "5.00",
        "filename": "flannelred.png",
        "tumbnail1": "flannelred@30.png",
        "tumbnail2": "flannelred@2x.png",
        "tumbnail3": "flannelred@3x.png"
    },
    {
        "id": "7",
        "type": "类型8",
        "name": "圆顶绒布蓝-矮款",
        "color": "蓝色",
        "texture": "绒布",
        "length": "48",
        "weight": "48",
        "height": "26",
        "price": "5.00",
        "filename": "flannelblue.png",
        "tumbnail1": "flannelblue@30.png",
        "tumbnail2": "flannelblue@2x.png",
        "tumbnail3": "flannelblue@3x.png"
    },
    {
        "id": "8",
        "type": "类型9",
        "name": "圆顶绒布黑-矮款",
        "color": "黑色",
        "texture": "绒布",
        "length": "48",
        "weight": "48",
        "height": "26",
        "price": "5.00",
        "filename": "flannelblack.png",
        "tumbnail1": "flannelblack@30.png",
        "tumbnail2": "flannelblack@2x.png",
        "tumbnail3": "flannelblack@3x.png"
    },
    {
        "id": "9",
        "type": "类型10",
        "name": "方顶绒布红-高款",
        "color": "红色",
        "texture": "绒布",
        "length": "42",
        "weight": "43",
        "height": "36",
        "price": "6.00",
        "filename": "flannelredhigh.png",
        "tumbnail1": "flannelredhigh@30.png",
        "tumbnail2": "flannelredhigh@2x.png",
        "tumbnail3": "flannelredhigh@3x.png"
    },
    {
        "id": "10",
        "type": "类型11",
        "name": "方顶绒布蓝-高款",
        "color": "蓝色",
        "texture": "绒布",
        "length": "42",
        "weight": "43",
        "height": "36",
        "price": "6.00",
        "filename": "flannelbluehigh.png",
        "tumbnail1": "flannelbluehigh@30.png",
        "tumbnail2": "flannelbluehigh@2x.png",
        "tumbnail3": "flannelbluehigh@3x.png"
    },
    {
        "id": "11",
        "type": "类型12",
        "name": "方顶绒布黑-高款",
        "color": "黑色",
        "texture": "绒布",
        "length": "42",
        "weight": "43",
        "height": "36",
        "price": "6.00",
        "filename": "flannelblackhigh.png",
        "tumbnail1": "flannelblackhigh@30.png",
        "tumbnail2": "flannelblackhigh@2x.png",
        "tumbnail3": "flannelblackhigh@3x.png"
    },
    {
        "id": "12",
        "type": "类型13",
        "name": "方盒-亚克力-小",
        "color": "黑色",
        "texture": "亚克力",
        "length": "40",
        "weight": "40",
        "height": "17",
        "price": "2.00",
        "filename": "pvc.png",
        "tumbnail1": "pvc@30.png",
        "tumbnail2": "pvc@2x.png",
        "tumbnail3": "pvc@2x.png"
    },
    {
        "id": "13",
        "type": "类型14",
        "name": "方盒-亚克力-大",
        "color": "黑色",
        "texture": "亚克力",
        "length": "60",
        "weight": "60",
        "height": "15",
        "price": "2.50",
        "filename": "pvc.png",
        "tumbnail1": "pvc@30.png",
        "tumbnail2": "pvc@2x.png",
        "tumbnail3": "pvc@2x.png"
    }
];


$(function () {
    $(".img").on('click', function () {

    });

    box.init();

    //关闭选择盒子
    $(".add-close").on('click', function () {
        $(".add-box-list").addClass('hide');
    });
    //添加盒子
    $(".add").on('click', function () {
        box.addBox();
    });

    $("#remarks").keyup(function () {
        var length = $(this).val().length;
        $(".text-count").text(length + "/300");
    });
});

var box = {
    init: function () {
        var that = this;
        that.getData();
    },
    getData: function () {
        var that = this;
        var data={
            "customid":Helper.getUrlParam('customid')
        };
        var url=config.WebService()["orderBoxAll_Query"];
        top.Requst.ajaxGet(url,data,false,function (data) {
            if(data.code==200 && data.data.length>0)
            {
                var list=data.data;
                for(var i=0;i<list.length;i++)
                {
                    var item=datasource[parseInt(list[i].boxtype)-1]
                    that.listAddItem({
                        "id": item.id,
                        "type": item.type,
                        "name": item.name,
                        "color": item.color,
                        "texture": item.texture,
                        "length": item.length,
                        "weight": item.weight,
                        "height": item.height,
                        "price": list[i].price,
                        "amount":list[i].amount,
                        "filename": item.filename,
                        "tumbnail1": item.tumbnail1,
                        "tumbnail2": item.tumbnail2,
                        "tumbnail3": item.tumbnail3
                    });
                }
               var remarks= list.length>0?list[0].remark:"";
                $(".text-count").text(remarks.length+"/300");
                $('#remarks').val(remarks);
            }
        })
    },
    addBox: function (obj) {//添加盒子
        var that = this;
        $(".add-box-list").removeClass('hide');
        var selectedArray = [];
        var seledItem = $("#datalist").find('li');//已选中的
        for (var i = 0; i < seledItem.length; i++) {
            var index = parseInt($(seledItem[i]).attr("data-id"));
            selectedArray.push(index);
        }
        var datalist = $(".box-container");
        datalist.html("");

        for (var i = 0; i < datasource.length; i++) {
            if (selectedArray.indexOf(i) >= 0)//排除已选中的
            {
                continue;
            }
            var item = $('<div data-id="' + datasource[i].id + '" title="' + datasource[i].name + '" data-src="../../Image/box/oringnalPic/' + datasource[i].filename + '" class="item"> <div class="img"> <img src="../../Image/box/thumbnail/' + datasource[i].tumbnail2 + '" > </div> <span>' + datasource[i].type + '</span> </div>');
            item.on('click', function () {//选中
                if (obj)//编辑
                {
                    var index = $(this).attr('data-id');
                    setParams(datasource[index]);
                }
                else {//添加
                    var index = $(this).attr('data-id');
                    that.listAddItem(datasource[index]);
                    $(".add-box-list").addClass('hide');
                }
            });
            datalist.append(item);
        }

        function setParams(item) {//改变某条盒子信息
            var tag = $(obj);
            tag.attr('data-id', item.id);
            tag.find('.type-name').text(item.type);
            tag.find('.img').attr('data-src', "../../Image/box/oringnalPic/" + item.filename);
            tag.find('.img img').attr('src', "../../Image/box/thumbnail/" + item.tumbnail2);
            tag.find('.color span').text(item.color);
            tag.find('.texture span').text(item.name);
            tag.find('.num input').text(item.amount||1);//数量
            tag.find('.size span').text(item.length + '*' + item.weight + '*' + item.height);
            $(".add-box-list").addClass('hide');
        }


    },
    listAddItem: function (datasource) {
        var that = this;
        var datalist = $("#datalist");
        var item = $('<li class="clearfix" data-id="' + datasource.id + '"></li>');
        var select = $('<div class="type fl"> <span class="type-name">' + datasource.type + '</span> <i class="icon"></i> </div>');
        select.on('click', function () {
            var rowObj = $(this).parent();
            that.addBox(rowObj);
        });//改变盒子类型

        item.append(select);
        var img = $('<div data-src="../Image/box/oringnalPic/' + datasource.filename + '" class="img fl"><img style="max-width: 60px; max-height: 60px;" src="../../Image/box/thumbnail/' + datasource.tumbnail2 + '"/></div>');
        item.append(img);
        img.on('click', function () {
            var obj = $(this);
            debugger
            parent.previewImg.create(obj.attr('data-src'));
            parent.previewImg.show();
        });
        item.append($('<div class="color fl"> <span>' + datasource.color + '</span> </div>'));
        item.append($('<div class="texture fl"> <span>' + datasource.name + '</span> </div>'));
        item.append($('<div class="size fl"> <span>' + datasource.length + '*' + datasource.weight + '*' + datasource.height + '</span> </div>'));
        var amount=datasource.amount||1;
        var numINPUT=$('<input maxlength="5" type="text" class="input-number" style="width: 100%" value="' + amount + '">');//数量
        //只允许输入数字
        numINPUT.keyup(function () {
            ConvertToInt($(this)[0]);
        });

        var numDIV=$('<div class="num fl">  </div>').append(numINPUT);
        item.append(numDIV);


        var price=parseFloat(datasource.price).formatMoney(2, "", ",", ".");
        var moneyINPUT=$('<input type="text" class="input-money" value="' + price + '"> ');
        var moneyDIV=$('<div class="money fl"> </div>').append(moneyINPUT);
        function MoneyToFloat(val) { //将字符串类型的金额转成float类型
            if (isNaN(val)) {
                val = val.replace(/[^0-9-.]/g, '');
            }
            return parseFloat(val);
        }

        // *************验证只允许输入金额格式-begin
        moneyINPUT.focus(function () {
            var stringVal = $(this);
            var floatVal = MoneyToFloat(stringVal.val());
            if (floatVal == 0)
                floatVal = "";
            stringVal.val(floatVal);
        });

        moneyINPUT.keyup(function () {
            var curobj = $(this);
            var reg = curobj.val().match(/(-?\d+\.?\d{0,2})|-/);
            var txt = '';
            if (reg != null) {
                txt = reg[0];
            }
            curobj.val(txt);
        });

        moneyINPUT.blur(function () {
            var curobj = $(this);
            var val = parseFloat(curobj.val());
            curobj.val(val.formatMoney(2, "", ",", "."));
        });




        item.append(moneyDIV);
        var del = $('<span class="del fl"></span>');
        del.on('click', function () {
            $(this).parent().remove();
        });
        item.append(del);
        datalist.append(item);
    },
    save: function () {
        var result = {"datas":[],"customid":""};
        //result["roleType"]=Helper.getUrlParam('customid');
        result.customid=Helper.getUrlParam('customid');
        var lis = $("#datalist").find('li');
        // if (lis.length <= 0) {
        //     parent.Common.msg("没有需要保存的数据", 400, 2000);
        //     return;
        // }
        for (var i = 0; i < lis.length; i++) {
            var item =$(lis[i]);
            var index=parseInt(item.attr("data-id"))+1;//对应列表的索引
            var color=item.find('.color span').text();//颜色
            var texture=item.find('.texture span').text();//材质
            var size=item.find('.size span').text();//材质
            var num=parseInt(item.find('.num input').val());
            var money=item.find('.money input').val().replace(/[^0-9-.]/g, '');


            if(num<=0)
            {
                parent.Common.msg("数量必须大于零",400,2000);
                item.find('.num input').focus();
                return;
            }

            if(money<=0)
            {
                parent.Common.msg("单价必须大于零",400,2000);
                item.find('.money input').focus();
                return;
            }

            result.datas.push({ "boxtype": index, "boxurl": "", "boxcolor": color, "quality": texture, "size": size, "amount": num, "price": money, "remark": "" });
        }

        if(result.datas.length>0)
        {
            result.datas[0].remark=$('#remarks').val();//备注
        }

        var url=config.WebService()["orderBoxInsert_Insert"];
        result.datas=JSON.stringify(result.datas);
        top.Requst.ajaxPost(url,result,true,function (data) {
            if(data.code==200)
            {
                top.Message.show("提示",data.message,MsgState.Success,2000,function () {
                    top.Popup.close("产品包装");
                });
            }
            else {
                console.log(data.message);
            }
        })
    }
};

function ConvertToInt(ob) {
    ob.value = ob.value.replace(/[^0-9]/g, '');
}
